name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  FORCE_COLOR: 1

jobs:
  # ==============================================================================
  # Stage 1: Static Analysis (parallel, no services needed)
  # ==============================================================================

  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm
      - run: pnpm lint
      - run: pnpm format:check

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm
      - run: pnpm typecheck

  # ==============================================================================
  # Stage 2: Unit Tests (parallel, no services - tests use mocks)
  # ==============================================================================

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm

      - name: Run unit tests with coverage
        run: pnpm test:unit --coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/lcov.info
          flags: unit
          fail_ci_if_error: false

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # ==============================================================================
  # Stage 3: Integration Tests (requires all 4 database services)
  # ==============================================================================

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: chive_test
          POSTGRES_USER: chive
          POSTGRES_PASSWORD: chive_test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_USER: chive
      POSTGRES_PASSWORD: chive_test_password
      POSTGRES_DB: chive_test
      DATABASE_URL: postgresql://chive:chive_test_password@localhost:5432/chive_test
      REDIS_URL: redis://localhost:6379
      ELASTICSEARCH_URL: http://localhost:9200
      NEO4J_URI: bolt://localhost:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: chive_test_password

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm
      - uses: ./.github/actions/start-services

      - name: Run integration tests
        run: pnpm test:integration

  # ==============================================================================
  # Stage 4: ATProto Compliance Tests (100% pass rate required)
  # ==============================================================================

  compliance-tests:
    name: ATProto Compliance
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: chive_test
          POSTGRES_USER: chive
          POSTGRES_PASSWORD: chive_test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_USER: chive
      POSTGRES_PASSWORD: chive_test_password
      POSTGRES_DB: chive_test
      DATABASE_URL: postgresql://chive:chive_test_password@localhost:5432/chive_test
      REDIS_URL: redis://localhost:6379
      ELASTICSEARCH_URL: http://localhost:9200
      NEO4J_URI: bolt://localhost:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: chive_test_password

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm
      - uses: ./.github/actions/start-services

      - name: Run compliance tests
        run: pnpm test:compliance

      - name: Compliance summary
        if: always()
        run: |
          echo "## ATProto Compliance Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All compliance tests must pass (100% required for ATProto data sovereignty)." >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # Stage 5: E2E Tests (DISABLED - re-enable when infrastructure is ready)
  # ==============================================================================

  # e2e-tests:
  #   name: E2E Tests (${{ matrix.browser }})
  #   runs-on: ubuntu-latest
  #   needs: [integration-tests]
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       browser: ${{ github.event_name == 'pull_request' && fromJSON('["chromium"]') || fromJSON('["chromium", "firefox", "webkit"]') }}
  #
  #   services:
  #     postgres:
  #       image: postgres:16-alpine
  #       env:
  #         POSTGRES_DB: chive_test
  #         POSTGRES_USER: chive
  #         POSTGRES_PASSWORD: chive_test_password
  #       ports:
  #         - 5432:5432
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5
  #
  #     redis:
  #       image: redis:7-alpine
  #       ports:
  #         - 6379:6379
  #       options: >-
  #         --health-cmd "redis-cli ping"
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5
  #
  #   env:
  #     POSTGRES_HOST: localhost
  #     POSTGRES_PORT: 5432
  #     POSTGRES_USER: chive
  #     POSTGRES_PASSWORD: chive_test_password
  #     POSTGRES_DB: chive_test
  #     DATABASE_URL: postgresql://chive:chive_test_password@localhost:5432/chive_test
  #     REDIS_URL: redis://localhost:6379
  #     ELASTICSEARCH_URL: http://localhost:9200
  #     NEO4J_URI: bolt://localhost:7687
  #     NEO4J_USER: neo4j
  #     NEO4J_PASSWORD: chive_test_password
  #     DISABLE_RATE_LIMITING: 'true'
  #
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/setup-node-pnpm
  #     - uses: ./.github/actions/start-services
  #
  #     - name: Cache Playwright browsers
  #       uses: actions/cache@v4
  #       id: playwright-cache
  #       with:
  #         path: ~/.cache/ms-playwright
  #         key: playwright-${{ runner.os }}-${{ matrix.browser }}-${{ hashFiles('**/pnpm-lock.yaml') }}
  #
  #     - name: Install Playwright browsers
  #       if: steps.playwright-cache.outputs.cache-hit != 'true'
  #       run: |
  #         # Always install chromium (needed for setup:auth project)
  #         pnpm exec playwright install --with-deps chromium
  #         # Install matrix browser if different from chromium
  #         if [ "${{ matrix.browser }}" != "chromium" ]; then
  #           pnpm exec playwright install --with-deps ${{ matrix.browser }}
  #         fi
  #
  #     - name: Install Playwright dependencies (cached)
  #       if: steps.playwright-cache.outputs.cache-hit == 'true'
  #       run: |
  #         pnpm exec playwright install-deps chromium
  #         if [ "${{ matrix.browser }}" != "chromium" ]; then
  #           pnpm exec playwright install-deps ${{ matrix.browser }}
  #         fi
  #
  #     - name: Run database migrations
  #       run: pnpm db:migrate:up
  #
  #     - name: Run E2E tests
  #       run: pnpm test:e2e --project="${{ matrix.browser }}:*"
  #
  #     - name: Upload Playwright report
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: playwright-report-${{ matrix.browser }}
  #         path: |
  #           playwright-report/
  #           tests/e2e/test-results/
  #         retention-days: 14

  # ==============================================================================
  # Stage 6: Build Verification
  # ==============================================================================

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, compliance-tests]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm

      - name: Build all packages
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

      - name: Build summary
        run: |
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All packages built successfully." >> $GITHUB_STEP_SUMMARY

  # ==============================================================================
  # Stage 7: Pre-Deployment Verification (runs scripts and jobs against test stack)
  # ==============================================================================

  pre-deployment-tests:
    name: Pre-Deployment Verification
    runs-on: ubuntu-latest
    needs: [build]
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: chive
          POSTGRES_USER: chive
          POSTGRES_PASSWORD: chive_test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_USER: chive
      POSTGRES_PASSWORD: chive_test_password
      POSTGRES_DB: chive
      DATABASE_URL: postgresql://chive:chive_test_password@localhost:5432/chive
      REDIS_URL: redis://localhost:6379
      ELASTICSEARCH_URL: http://localhost:9200
      NEO4J_URI: bolt://localhost:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: chive_test_password

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm
      - uses: ./.github/actions/start-services

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Run database migrations
        run: pnpm db:migrate:up

      - name: Seed test data
        run: pnpm seed:test

      - name: Run pre-deployment tests
        run: pnpm test:pre-deployment

      - name: Pre-deployment summary
        if: always()
        run: |
          echo "## Pre-Deployment Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verified that all scripts, jobs, and services function correctly." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks performed:" >> $GITHUB_STEP_SUMMARY
          echo "- Service health (PostgreSQL, Elasticsearch, Neo4j, Redis)" >> $GITHUB_STEP_SUMMARY
          echo "- Elasticsearch schema and mappings" >> $GITHUB_STEP_SUMMARY
          echo "- Neo4j schema and indexes" >> $GITHUB_STEP_SUMMARY
          echo "- Indexing pipeline with nested field_nodes" >> $GITHUB_STEP_SUMMARY
          echo "- Script execution (reindex, setup)" >> $GITHUB_STEP_SUMMARY
          echo "- Job and worker module imports" >> $GITHUB_STEP_SUMMARY
