# Redis RDB Backup CronJob
# Creates RDB snapshots and copies to backup storage
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-backup-scripts
  namespace: chive
  labels:
    app.kubernetes.io/name: redis-backup
    app.kubernetes.io/part-of: chive
data:
  backup.sh: |
    #!/bin/sh
    set -e

    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="/backups/redis_${TIMESTAMP}.rdb"

    echo "[$(date)] Starting Redis backup..."

    # Trigger BGSAVE on Redis
    redis-cli -h "${REDIS_HOST}" BGSAVE

    # Wait for BGSAVE to complete
    while [ "$(redis-cli -h ${REDIS_HOST} LASTSAVE)" == "$(redis-cli -h ${REDIS_HOST} LASTSAVE)" ]; do
      echo "[$(date)] Waiting for BGSAVE to complete..."
      sleep 2
    done

    echo "[$(date)] BGSAVE complete"

    # Copy RDB file from Redis container
    # Note: This requires the Redis pod to have the backup volume mounted
    cp /data/dump.rdb "${BACKUP_FILE}" 2>/dev/null || {
      echo "[$(date)] Warning: Could not copy RDB file directly"
      echo "[$(date)] Using redis-cli to dump data..."
      redis-cli -h "${REDIS_HOST}" --rdb "${BACKUP_FILE}"
    }

    # Compress
    gzip "${BACKUP_FILE}"

    echo "[$(date)] Backup created: redis_${TIMESTAMP}.rdb.gz"

    # Cleanup old backups (keep last 7)
    cd /backups
    ls -t redis_*.rdb.gz 2>/dev/null | tail -n +8 | xargs -r rm -f

    echo "[$(date)] Redis backup complete"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-backups
  namespace: chive
  labels:
    app.kubernetes.io/name: redis-backup
    app.kubernetes.io/part-of: chive
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: redis-backup
  namespace: chive
  labels:
    app.kubernetes.io/name: redis-backup
    app.kubernetes.io/part-of: chive
spec:
  schedule: "0 5 * * *"  # Daily at 5 AM UTC
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app.kubernetes.io/name: redis-backup
        spec:
          restartPolicy: OnFailure
          containers:
            - name: backup
              image: redis:7-alpine
              command: ["/bin/sh", "/scripts/backup.sh"]
              env:
                - name: REDIS_HOST
                  value: "redis.chive.svc.cluster.local"
              volumeMounts:
                - name: scripts
                  mountPath: /scripts
                - name: backups
                  mountPath: /backups
              resources:
                requests:
                  cpu: "50m"
                  memory: "64Mi"
                limits:
                  cpu: "200m"
                  memory: "128Mi"
          volumes:
            - name: scripts
              configMap:
                name: redis-backup-scripts
                defaultMode: 0755
            - name: backups
              persistentVolumeClaim:
                claimName: redis-backups
